# angee.yaml — {{ .ProjectName }}
# Source of truth. Edit directly or ask your admin agent.
# Generated from: angee default template
name: {{ .ProjectName }}

# ─── Platform services ────────────────────────────────────────────────────────

services:
  operator:
    image: ghcr.io/fyltr/angee-operator:latest
    lifecycle: system
    infrastructure: true
    ports:
      - "9000:9000"
    raw_volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/angee-root
    env:
      ANGEE_ROOT: /angee-root
      BAO_ADDR: "http://openbao:8200"
      BAO_TOKEN: dev-root-token
    health:
      path: /health
      port: 9000
      interval: 10s
      timeout: 5s

  traefik:
    image: traefik:v3
    lifecycle: system
    infrastructure: true
    ports:
      - "3333:80"
      - "443:443"
    raw_volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command: >-
      traefik
      --providers.docker=true
      --providers.docker.exposedbydefault=false
      --entrypoints.web.address=:80
      --entrypoints.websecure.address=:443
      --api.dashboard=true
      --api.insecure=true
    volumes:
      - name: traefik-certs
        path: /certs
        persistent: true

  openbao:
    image: openbao/openbao:2
    lifecycle: system
    infrastructure: true
    ports:
      - "8200:8200"
    command: server -dev -dev-root-token-id=dev-root-token
    env:
      BAO_DEV_ROOT_TOKEN_ID: dev-root-token
    volumes:
      - name: bao-data
        path: /openbao/data
        persistent: true

# ─── Secrets backend ────────────────────────────────────────────────────────

secrets_backend:
  type: openbao
  openbao:
    address: http://openbao:8200
    auth:
      method: token
      token_env: BAO_TOKEN
    prefix: angee

# ─── MCP servers ─────────────────────────────────────────────────────────────

mcp_servers:

  angee-operator:
    transport: streamable-http
    url: http://operator:9000/mcp
    credentials:
      source: service_account
      scopes:
        - config.read
        - config.write
        - deploy
        - rollback
        - status
        - logs
        - scale
        - secrets.list
        - secrets.write

  angee-files:
    transport: stdio
    image: ghcr.io/fyltr/angee-filesystem-mcp:latest
    command:
      - node
      - /usr/local/lib/mcp-filesystem/dist/index.js
    args:
      - /workspace
    credentials:
      source: none

# ─── Agents ──────────────────────────────────────────────────────────────────

agents:

  angee-admin:
    image: ghcr.io/anomalyco/opencode:latest
    command: serve --hostname 0.0.0.0 --port 4096
    lifecycle: system
    role: operator
    description: "Platform admin — manages deployment, config, secrets, and infrastructure"
    mcp_servers:
      - angee-operator
      - angee-files
    files:
      - template: opencode.json.tmpl
        mount: /root/.config/opencode/opencode.json
    workspace:
      persistent: true
    env:
      ANTHROPIC_API_KEY: "${secret:anthropic-api-key}"

# ─── Secrets ─────────────────────────────────────────────────────────────────
# Secrets are stored in OpenBao (dev mode). Use `angee credential set` to manage.
# In dev mode, secrets are also written to .env for convenience.

secrets:
  - name: anthropic-api-key
    description: "Anthropic API key for AI agents (get yours at console.anthropic.com)"
    required: true
